<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>dailydiary</title>
</head>
<body>
<div>
    <h3>오늘 하루를 기록해보세요.</h3>
    <h1>한솔이의 일기장 수정하기</h1>
</div>
<div class="register-container">
    <form id="form" name="form">
        <table>
            <tr>
                <td><input type="text" th:value="${diaryDTO.title}" name="title"/></td>
            </tr>
            <tr>
                <td><input type="text" th:value="${diaryDTO.content}" name="content"></td>
            </tr>
            <tr>
                <td><label for="file">첨부파일</label>
                    <input type="file" class="form-control-file" id="file" name="file"></td>
            </tr>

            <tr th:if="${diaryDTO.fileName ne null}" id="imgTr">
                <td>
                    <label>기존 이미지</label>
                    <img th:src="@{'/uploads/' + ${diaryDTO.fileName}}" width="300" alt="게시글 이미지">
                    <input type="button" value="삭제" th:onclick="clearImg()">
                    <input type="hidden" value="false" name="deleteImgCheck">
                </td>
            </tr>

            <!--            <tr>-->
            <!--                <td><input type="text" value="${diaryDTO.date}"></td>-->
            <!--            </tr>-->
        </table>
        <input type="submit" value="수정" th:onclick="'updateDiary(' + ${diaryDTO.boardSeq} + '); return false;'">
        <input type="button" value="목록" th:onclick="goDiaryList()">
        <!--        <input type="button" id="deleteBtn" th:onclick="|window.location.href='/diary/${diaryDTO.boardSeq}'|" value="삭제">-->
        <!--        var form = $('#form')[0];-->
        <!--        var formData = new FormData(form);-->

    </form>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
    function clearImg(){
        var deleteImageClicked = confirm('기존 이미지를 삭제하시겠습니까?');
        var deleteImgCheck = $('input[name="deleteImgCheck"]');

        if(deleteImageClicked){
            $("#imgTr").hide();
            deleteImgCheck.val("true");
        }
    }

/*
        // 기존 이미지 삭제 시에는 file 입력 요소를 초기화
        if (deleteImageClicked) {
            var fileInput = $('input[name="file"]')[0];
            fileInput.value = null;
        }
        $("#imgTr").hide();


    }*/

    function updateDiary(boardSeq){

        var title = $('input[name="title"]').val();
        var content = $('input[name="content"]').val();
        var deleteImgCheck = $('input[name="deleteImgCheck"]').val();
        var fileInput = $('input[name="file"]')[0]; // 파일 입력 요소 가져오기
        var file = fileInput.files[0]; // 선택된 파일 가져오기

        if(title.length > 40){
            alert("제목이 너무 길어요. 40자 이하로 적어주세요.");
            return false;
        }if(content.length > 1000){
            alert("내용이 너무 길어요. 1000자 이하로 적어주세요.");
            return false;
        }
        if(title == null || title.trim() == ""){
            alert("제목을 입력하세요.");
            return false;
        }
        if(content == null || content.trim() == ""){
            alert("내용을 입력하세요.");
            return false;
        }
        if (deleteImgCheck === undefined || deleteImgCheck === null) {
            deleteImgCheck = false; // 값이 없을 때 기본적으로 false로 설정
        }

        var formData = new FormData();

        formData.append('boardSeq', boardSeq);
        formData.append('title', title);
        formData.append('content', content);
        formData.append('file', file);
        formData.append('deleteImgCheck', deleteImgCheck);

        $.ajax({
            type: "PUT",
            url: "/daily-list/diary",
            data: formData,
            processData: false, // FormData 객체 그대로 전송하기 위해 필요
            contentType: false, // FormData 객체 그대로 전송하기 위해 필요
            success: function(success){
                console.log(success);
                if (success === "success") {
                    alert("수정성공");
                    location.href="/daily-list/diary/"+boardSeq;
                } else {
                    alert("수정 실패");
                }
            },
            error: function(xhr, status, error) {
                console.error("에러 발생:", error);
            }
        });
    }



    function goDiaryList(){
        location.href="/daily-list/1";
    }

    function deleteDiary(boardSeq){
    const check = confirm('삭제하시겠습니까?');

    if(check){
        $.ajax({
            type: "DELETE",
            url: "/daily-list/diary/"+boardSeq,
            success: function(result){
                alert("일기가 삭제 되었습니다.");
                location.href="/daily-list/1";
            },
            error: function(xhr, status, error) {
                console.error("에러 발생:", error);
            }
        });
    }


};

</script>
</body>
</html>
